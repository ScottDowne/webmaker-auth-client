(function(){"use strict";function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype,e=this,f=e.EventEmitter;d.getListeners=function(a){var b,c,d=this._getEvents();if(a instanceof RegExp){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if(a instanceof RegExp)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return e.EventEmitter=f,a},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:this.EventEmitter=a}).call(this),function(a){function b(b){return function(c){a.localStorage||console.error("Local storage must be supported for instant login.");var d=this;c=c||{},c.paths=c.paths||{},d.emitter=new b,d.host=c.host||"",d.paths=c.paths||{},d.paths.authenticate=c.paths.authenticate||"/authenticate",d.paths.create=c.paths.create||"/create",d.paths.verify=c.paths.verify||"/verify",d.paths.logout=c.paths.logout||"/logout",d.paths.checkUsername=c.paths.checkUsername||"/check-username",d.urls={authenticate:d.host+d.paths.authenticate,create:d.host+d.paths.create,verify:d.host+d.paths.verify,logout:d.host+d.paths.logout,checkUsername:d.host+d.paths.checkUsername},d.audience=c.audience||a.location.origin,d.prefix=c.prefix||"webmaker-",d.timeout=c.timeout||10,d.localStorageKey=d.prefix+"login",d.csrfToken=c.csrfToken,d.handleNewUserUI=c.handleNewUserUI===!1?!1:!0,d.modal={},d.modal.element=document.getElementById("webmaker-login-new-user"),d.modal.dismissSelector="[data-dismiss]",d.modal.createSelector=".create-user",d.modal.createBtnOnClick=function(){},d.modal.checkUsernameOnChange=function(){var a=d.modal.element.querySelector(".username-taken-error"),b=d.modal.element.querySelector(".username-required-error"),c=d.modal.element.querySelector(".username-group"),e=this.value;d.checkUsername(e,function(d){d?(c.classList.add("has-error"),c.classList.remove("has-success"),a.classList.remove("hidden")):e?(c.classList.remove("has-error"),c.classList.add("has-success"),a.classList.add("hidden"),b.classList.add("hidden")):(c.classList.remove("has-success"),c.classList.add("has-error"),a.classList.add("hidden"),b.classList.remove("hidden"))})},d.modal.setup=function(a){var b=d.modal.element.querySelector(d.modal.createSelector),c=d.modal.element.querySelectorAll(d.modal.dismissSelector),e=d.modal.element.querySelector(".username-group"),f=d.modal.element.querySelector(".agree-group"),g=d.modal.element.querySelector(".username-taken-error"),h=d.modal.element.querySelector(".username-required-error"),i=d.modal.element.querySelector(".agree-error"),j=d.modal.element.querySelector('[name="username"]'),k=d.modal.element.querySelector('[name="agreeToTerms"]'),l=d.modal.element.querySelector('[name="mailingList"]');b.removeEventListener("click",d.modal.createBtnOnClick,!1),j.addEventListener("change",d.modal.checkUsernameOnChange,!1),d.modal.createBtnOnClick=function(){var b=!1;k.checked||(f.classList.add("has-error"),i.classList.remove("hidden"),b=!0),j.value||(e.classList.add("has-error"),e.classList.remove("has-success"),h.classList.remove("hidden"),b=!0),b||(d.createUser({assertion:a,user:{username:j.value,mailingList:l.checked}}),g.classList.add("hidden"),h.classList.add("hidden"),i.classList.add("hidden"),e.classList.remove("has-error"),e.classList.remove("has-success"),f.classList.remove("has-error"),d.modal.close())};for(var m=0;m<c.length;m++)c[m].removeEventListener("click",d.modal.close,!1),c[m].addEventListener("click",d.modal.close,!1);b.addEventListener("click",d.modal.createBtnOnClick,!1)},d.modal.open=function(){d.modal.element.classList.add("in"),d.modal.element.style.display="block",d.modal.element.setAttribute("aria-hidden",!1)},d.modal.close=function(){d.modal.element.classList.remove("in"),d.modal.element.style.display="none",d.modal.element.setAttribute("aria-hidden",!0)},d.on=function(a,b){d.emitter.addListener(a,b)},d.off=function(a,b){d.emitter.removeListener(a,b)},d.checkUsername=function(a,b){var c=new XMLHttpRequest,e=JSON.stringify({username:a});c.open("POST",d.urls.checkUsername,!0),c.setRequestHeader("Content-type","application/json"),c.setRequestHeader("X-CSRF-Token",d.csrfToken),c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=JSON.parse(c.responseText);a.exists?b(!0,"Username taken"):b(!1,"Username not taken")}else 4===c.readyState&&c.status&&(c.status>=400||c.status<200)?(d.emitter.emitEvent("error",[c.responseText]),b(!1,"Error checking username")):4===c.readyState&&(d.emitter.emitEvent("error",["Looks like "+d.urls.checkUsername+" is not responding..."]),b(!1,"Error checking username"))},c.send(e)},d.createUser=function(a){var b=new XMLHttpRequest,c=JSON.stringify({assertion:a.assertion,audience:d.audience,user:a.user});b.open("POST",d.urls.create,!0),b.setRequestHeader("Content-type","application/json"),b.setRequestHeader("X-CSRF-Token",d.csrfToken),b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var a=JSON.parse(b.responseText);a.user?(d.storage.set(a.user),d.emitter.emitEvent("login",[a.user,"user created"])):d.emitter.emitEvent("error",[b.responseText])}else 4===b.readyState&&b.status&&(b.status>=400||b.status<200)?d.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&d.emitter.emitEvent("error",["Looks like "+d.urls.create+" is not responding..."])},console.log(b),b.send(c)},d.verify=function(){d.storage.get()&&d.emitter.emitEvent("login",[d.storage.get(),"restored"]);var a=d.storage.get("email"),b=new XMLHttpRequest,c=JSON.stringify({email:a});b.open("POST",d.urls.verify,!0),b.setRequestHeader("Content-type","application/json"),b.setRequestHeader("X-CSRF-Token",d.csrfToken),b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var c=JSON.parse(b.responseText),e=d.storage.get();a&&c.email===a?d.emitter.emitEvent("verified",[e]):c.user?(d.storage.set(c.user),d.emitter.emitEvent("login",[c.user,"email mismatch"])):a&&!c.user?d.logout():d.emitter.emitEvent("verified",!1)}else 4===b.readyState&&b.status&&(b.status>=400||b.status<200)?d.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&d.emitter.emitEvent("error",["Looks like "+d.urls.verify+" is not responding..."])},b.send(c)},d.login=function(){a.navigator.id||console.error("No persona found. Did you include include.js?"),a.navigator.id.get(function(a){({audience:d.audience,assertion:a});a||d.emitter.emitEvent("error",["No assertion was received"]);var b=new XMLHttpRequest,c=JSON.stringify({audience:d.audience,assertion:a});if(d.timeout)var e=setTimeout(function(){d.emitter.emitEvent("error",["The request for a token timed out after "+d.timeout+" seconds"])},1e3*d.timeout);b.open("POST",d.urls.authenticate,!0),b.setRequestHeader("Content-type","application/json"),b.setRequestHeader("X-CSRF-Token",d.csrfToken),b.onreadystatechange=function(){if(d.timeout&&e&&clearTimeout(e),4==b.readyState&&200==b.status){var c=JSON.parse(b.responseText);c.error&&d.emitter.emitEvent("error",[c.error]),c.user&&(d.storage.set(c.user),d.emitter.emitEvent("login",[c.user,"authenticate"])),c.email&&!c.user&&(d.emitter.emitEvent("newuser",[a,c.email]),d.handleNewUserUI&&(d.modal.setup(a,c.email),d.modal.open())),c.err&&d.emitter.emitEvent("error",[c.err])}else 4===b.readyState&&b.status&&(b.status>=400||b.status<200)?d.emitter.emitEvent("error",[b.responseText]):4===b.readyState&&d.emitter.emitEvent("error",["Looks like "+d.urls.authenticate+" is not responding..."])},b.send(c)})},d.logout=function(){var a=new XMLHttpRequest;a.open("POST",d.urls.logout,!0),a.setRequestHeader("X-CSRF-Token",d.csrfToken),a.send(null),d.emitter.emitEvent("logout"),d.storage.clear()},d.storage={get:function(a){var b=JSON.parse(localStorage.getItem(d.localStorageKey));if(b)return a?b[a]:b},set:function(a){var b=JSON.parse(localStorage.getItem(d.localStorageKey))||{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);localStorage.setItem(d.localStorageKey,JSON.stringify(b))},clear:function(){delete localStorage[d.localStorageKey]}}}}"function"==typeof define&&define.amd?define(["eventEmitter/EventEmitter"],b):a.WebmakerAuthClient=b(a.EventEmitter)}(window);